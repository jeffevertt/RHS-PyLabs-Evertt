from lib.window_space3d import *
from lib.winobj_star import *
from lib.utils import *
from typing import List

# spawn stars in this method
#   - you are given the current number of stars in the scene (you'll want to spawn up to some number of them, maybe 200 or so)
#   - you should spawn them out in front of the camera (in the camera's FOV)
#   - you can use functions in WindowSpace3D to get information about the camera, some relevant ones...
#       window.getCameraPos(), window.getCameraForward(), window.getCameraRight(), window.getCameraUp()
#       window.getCameraNearClipPlaneRight(), window.getCameraNearClipPlaneUp(), window.getCameraNearClipDst()
#       window.toCameraSpace(...), window.toWorldSpaceFromCameraSpace(...)
def spawnStars(window: WindowSpace3D, numStarsCurrent: int):
    for i in range(max(200 - numStarsCurrent, 0)):
        ptOnNearPlane = window.getCameraPos() + \
                        window.getCameraNearClipPlaneRight() * randRange(-1, 1) + \
                        window.getCameraNearClipPlaneUp() * randRange(-1, 1) + \
                        window.getCameraForward() * window.getCameraNearClipDst()
        dirWorldSpace = unit(ptOnNearPlane - window.getCameraPos())
        Star(window, window.getCameraPos() + dirWorldSpace * 500)

# update your camera in this method
#   - you are provided a subset of button state (either pressed on not pressed)
#       for example, wasdBtns[0] is True when 'w' is pressed and wasdBtns[1] is True when '2' is pressed.
#                    likewise, shiftCtrlBtns[0] is True when the shift key is pressed
#   - you can query the current camera state from window, and then set it using window.setCameraPos(...) & window.setCameraOrient(...)
camVel = v3_zero()
def updateCamera(window: WindowSpace3D, wasdBtns: List[bool], shiftCtrlBtns: List[bool], deltaTime: float):
    global camVel
    accelForce = 200 #if shiftCtrlBtns[0] else 20
    dampCamera = True
    if wasdBtns[0]:
        camVel += window.getCameraForward() * deltaTime * accelForce
        dampCamera = False
    if wasdBtns[1]:
        camVel += window.getCameraLeft() * deltaTime * accelForce
        dampCamera = False
    if wasdBtns[2]:
        camVel += window.getCameraBackwards() * deltaTime * accelForce
        dampCamera = False
    if wasdBtns[3]:
        camVel += window.getCameraRight() * deltaTime * accelForce
        dampCamera = False
    window.setCameraPos( window.getCameraPos() + camVel * deltaTime )
    if dampCamera:
        camVel *= (1 - deltaTime * 1.0)

# todo: student adds stars out front of the camera
# todo: student culls stars behind the camera
# todo: student does camera rotation from mouse delta & camera position based on WASD

####################################################################################################
############################## DO NOT MODIFY  METHODS BELOW THIS LINE ##############################
########################## EXCEPT TO REMOVE TUTORIAL GAME CONFIG ARGUMENT  #########################
####################################################################################################
WindowSpace3D("Lab 17: Star Field 3D!", spawnStarsFn = spawnStars, updateCameraFn = updateCamera).runGameLoop()